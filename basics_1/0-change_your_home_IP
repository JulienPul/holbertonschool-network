#!/usr/bin/env bash
# Configure /etc/hosts so localhost -> 127.0.0.2 and facebook.com -> 8.8.8.8 (idempotent)

set -euo pipefail
IFS=$'\n\t'

tmp="$(mktemp)"

# 1) On part de /etc/hosts en supprimant les tokens 'localhost' et 'facebook.com'
#    (même sur la ligne IPv6 ::1) pour éviter les doublons/priorités foireuses
awk '
  /^[[:space:]]*#/ { print; next }          # garder les commentaires
  {
    out=""
    for (i=1; i<=NF; i++) {
      if ($i != "localhost" && $i != "facebook.com") {
        out = out (out=="" ? $i : " " $i)
      }
    }
    if (out != "") print out
  }
' /etc/hosts > "$tmp"

# 2) On préfixe avec nos 2 mappages (ordre = priorité)
{
  printf '127.0.0.2 localhost\n'
  printf '8.8.8.8 facebook.com\n'
  cat "$tmp"
} > "${tmp}.new"

# 3) Remplacement (pas de sortie)
cp "${tmp}.new" /etc/hosts

rm -f "$tmp" "${tmp}.new"
